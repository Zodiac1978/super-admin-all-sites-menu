/*! For license information please see all-sites-menu.js.LICENSE.txt */
(()=>{"use strict";class t{constructor(t,e,n){this.name=t,this.table=e,this.keys=n}database(){const t=new Dexie(this.name);let e=1;for(let n of this.keys)t.version(e).stores({[this.table]:n}),e++;return t}async save(t){const e=this.database();await e[this.table].bulkPut(t).then((()=>{e.close()})).catch((t=>{console.error(t)}))}async read(t="name"){const e=this.database();return await e[this.table].orderBy(t).toArray().then((t=>(e.close(),t))).catch((t=>{console.error(t)}))}async getFirstRow(){const t=this.database();return await t[this.table].orderBy(":id").first().then((e=>(t.close(),e))).catch((t=>{console.error(t)}))}async delete(){const t=new Dexie(this.name);await t.delete().then((()=>{t.close()})).catch((t=>{console.warn(t)}))}async count(){const t=this.database();return await t[this.table].count().then((e=>(t.close(),e))).catch((t=>{console.error(t)}))}async getVersion(){return await new Dexie(this.name).open().then((t=>{const e=t.verno;return t.close(),e})).catch((t=>{console.error(t)}))}}async function e(t){const n=document.querySelector("#load-more-increment"),a=new FormData;a.append("action","all_sites_menu_action"),a.append("nonce",pluginAllSitesMenu.nonce),a.append("increment",n.dataset.increment);const s=pluginAllSitesMenu.ajaxurl;try{const i=await fetch(s,{method:"POST",credentials:"same-origin",body:a}),l=await i.json();"success"===l.response&&(n.dataset.increment=parseInt(n.dataset.increment)+pluginAllSitesMenu.loadincrements,t.save(l.data),await e(t))}catch(t){console.error(t)}}function n(t,e){let n;return!!t&&(t.classList&&t.classList.contains?t.classList.contains(e):!!t.className&&(n=t.className.split(" "),n.indexOf(e)>-1))}document.addEventListener("DOMContentLoaded",(()=>{if(!document.getElementById("wpadminbar"))return;const a={load:document.querySelector("#wp-admin-bar-load-more"),menu:document.querySelector("#wp-admin-bar-my-sites-list"),increment:document.querySelector("#load-more-increment")};!0===pluginAllSitesMenu.displaySearch&&function(){const t=document.querySelector("#all-sites-search-text");null!==t&&t.addEventListener("keyup",(t=>{t.preventDefault();const e=t.target.value.toUpperCase(),n=document.querySelector("#wp-admin-bar-my-sites-list").getElementsByClassName("menupop");for(let t=0;t<n.length;t++){let a=n[t].querySelector(".ab-item");(a.textContent||a.innerText).toUpperCase().indexOf(e)>-1?n[t].style.display="":n[t].style.display="none"}}))}();const s=new t("allsites","sites",["id,name,url","id,name,url,timestamp"]);var i;!async function(t,n){const a=await t.getFirstRow();void 0!==a&&void 0!==a.timestamp&&n.increment.dataset.timestamp>a.timestamp&&await t.delete(),0===await t.count()&&(n.increment.dataset.increment=0,n.increment.style.display="",e(t))}(s,a),i=a.menu,new IntersectionObserver((t=>{t.forEach((t=>{const e=t.boundingClientRect,n=e.bottom<window.innerHeight&&e.bottom;if(window.matchMedia("(min-width: 783px)").matches){const t=document.querySelector("#wp-admin-bar-my-sites>.ab-sub-wrapper");n?(t.style.height="",t.querySelector("ul#wp-admin-bar-my-sites-list").style.paddingBottom="0"):(t.style.height="calc(100vh - 32px)",t.querySelector("ul#wp-admin-bar-my-sites-list").style.paddingBottom="32px")}}))}),{threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}).observe(i);const l=function(t,e){const i=new IntersectionObserver((e=>{e.forEach((t=>{const{isIntersecting:e}=t;e&&(async()=>{const t=(await s.read(pluginAllSitesMenu.orderBy)).reduce(((t,e)=>t+function(t){return`\n\t\t\t\t<li id="wp-admin-bar-${t.id}" class="menupop">\n\t\t\t\t<a class="ab-item" aria-haspopup="true" href="${t.admin}/"><span class="wp-admin-bar-arrow" aria-hidden="true"></span>\n\t\t\t\t\t${t.title}\n\t\t\t\t</a>\n\t\t\t\t<div class="ab-sub-wrapper">\n\t\t\t\t\t<ul id="wp-admin-bar-${t.id}-default" class="ab-submenu">\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-d"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.admin}">${pluginAllSitesMenu.l10n.dashboard}</a></li>\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-n"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.admin}/post-new.php">${pluginAllSitesMenu.l10n.newpost}</a></li>\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-o"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.admin}/post-new.php?post_type=page">${pluginAllSitesMenu.l10n.newpage}</a></li>\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-c"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.admin}/edit-comments.php">${pluginAllSitesMenu.l10n.managecomments}</a></li>\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-u"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.admin}/users.php">${pluginAllSitesMenu.l10n.users}</a></li>\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-p"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.admin}/plugins.php">${pluginAllSitesMenu.l10n.plugins}</a></li>\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-s"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.admin}/options-general.php">${pluginAllSitesMenu.l10n.settings}</a></li>\n\t\t\t\t\t\t<li id="wp-admin-bar-${t.id}-v"><a class="ab-item"\n\t\t\t\t\t\t\t\thref="${t.url}/">${pluginAllSitesMenu.l10n.visit}</a></li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</li>\n\t\t`}(e)),"");a.load.insertAdjacentHTML("beforeBegin",t),function(){const t=document.getElementById("wp-admin-bar-my-sites-list");t&&(t.addEventListener("mouseenter",(t=>{t.stopPropagation(),t.target.classList.contains("menupop")&&function(t,e){if(!t)return;t.classList&&t.classList.add?t.classList.add(e):n(t,e)||(t.className&&(t.className+=" "),t.className+=e);let a=t.getBoundingClientRect().top,s=t.querySelector(".ab-submenu");s.style.top=a-6+"px",s.getBoundingClientRect().bottom>window.innerHeight&&(s.style.top="auto",s.style.bottom="0")}(t.target,"hover")}),{capture:!0}),t.addEventListener("mouseleave",(t=>{t.stopPropagation(),t.target.classList.contains("menupop")&&function(t,e){let a,s;if(t||n(t,e))if(t.classList&&t.classList.remove)t.classList.remove(e);else{for(a=` ${e} `,s=` ${t.className} `;s.indexOf(a)>-1;)s=s.replace(a,"");t.className=s.replace(/^[\s]+|[\s]+$/g,"")}}(t.target,"hover")}),{capture:!0}),t.addEventListener("keydown",(t=>{"Tab"===t.key&&(t.preventDefault(),t.target.classList.contains("menupop")&&toggleClass(t.target,"hover"))}),{capture:!0}))}(),a.load.style.display="none",l.unobserve(a.load)})()}),{root:t})}));return i.observe(t),i}(a.load)}))})();